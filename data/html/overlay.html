
<!DOCTYPE html>
<html lang="en" class="">

<head>
<meta charset='utf-8'>
	<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
	<title>Upload Overlay</title>
	<style>
	body {
		text-align: center;
		font-family: verdana, sans-serif;
		background: #000000;
		/*zoom: 2;
		-moz-transform: scale(2);
		-moz-transform-origin: 0 0;*/
	}
	canvas{
		background-color: #002400;
		display: none;
		/*image-rendering: pixelated;*/
	}
	div {
		padding: 5px;
		font-size: 1rem;
	}
	
	p {
		margin: 0.5rem 0;
	}
	
	image {
		display: inline-block;
		margin: auto;
		vertical-align: middle;
	}
	button,
	input[type="button"] {
		border: 0;
		border-radius: 0.3rem;
		background: #1fa3ec;
		color: #faffff;
		line-height: 2.4rem;
		font-size: 1.2rem;
		width: 100%;
		-webkit-transition-duration: 0.4s;
		transition-duration: 0.4s;
		cursor: pointer;
	}
	input[type="button"]:hover {
		background: #0e70a4;
	}
	input[name="emoji"] { width: auto; display: inline; background:none; border:none; }

	/* HIDE RADIO */
	[type=radio] { 
		position: absolute;
		opacity: 0;
		width: 0;
		height: 0;
	}

	/* IMAGE STYLES */
	[type=radio] + img {
		cursor: pointer;
	}

	/* CHECKED STYLES */
	[type=radio]:checked + img {
		outline: 2px solid #f00;
	}
	
	</style>
</head>
<body>



	<div style="text-align:left;display:inline-block;color:#eaeaea;min-width:340px;">
		<div style="text-align:center;color:#eaeaea;">
		<form method='POST' onSubmit="upload()">
			<div style='text-align:center;'>Enter character(s):</div>
			<input type="text" id="text" maxlength=2 style="display: block; text-align: center; margin:0 auto" required>
			<input type="button" name="emoji" value="ðŸ™‚">
			<input type="button" name="emoji" value="ðŸ¤£">
			<input type="button" name="emoji" value="ðŸ¤ª">
			<input type="button" name="emoji" value="ðŸ¤“">
			<input type="button" name="emoji" value="ðŸ˜Ž">
			<input type="button" name="emoji" value="ðŸ¥³">
			<br>
			<input type="button" name="emoji" value="ðŸ¦”">
			<input type="button" name="emoji" value="ðŸ•">
			<input type="button" name="emoji" value="ðŸˆ">
			<input type="button" name="emoji" value="ðŸ’">
			<input type="button" name="emoji" value="ðŸ˜">
			<input type="button" name="emoji" value="ðŸŒ»">
			<br>
			<input type="button" name="emoji" value="ðŸ•">
			<input type="button" name="emoji" value="ðŸŸ">
			<input type="button" name="emoji" value="ðŸŽ‚">
			<input type="button" name="emoji" value="ðŸŒˆ">
			<input type="button" name="emoji" value="ðŸ«€">
			<input type="button" name="emoji" value="ðŸ‘">
			<br>
			<input type="button" name="emoji" value="ðŸŽ…">
			<input type="button" name="emoji" value="â„ï¸">
			<input type="button" name="emoji" value="ðŸŽ„">
			<input type="button" name="emoji" value="â›„">
			<input type="button" name="emoji" value="ðŸŽ">
			<input type="button" name="emoji" value="â­">
			<br>
			<input type="button" name="emoji" value="ðŸ‘½">
			<input type="button" name="emoji" value="ðŸ’€">
			<input type="button" name="emoji" value="ðŸŽƒ">
			<input type="button" name="emoji" value="ðŸ‘»">
			<input type="button" name="emoji" value="ðŸ§Ÿ">
			<input type="button" name="emoji" value="ðŸ§ ">
			<br>
			<input type="button" name="emoji" value="ðŸ’©">
			<input type="button" name="emoji" value="ðŸ¤–">
			<input type="button" name="emoji" value="ðŸš€">
			<input type="button" name="emoji" value="ðŸ›¸">
			<input type="button" name="emoji" value="â˜¢ï¸">
			<input type="button" name="emoji" value="ðŸ’£">
			<canvas id="canvas"></canvas>
			<br>
			<div style="text-align:center;">White border represents size of display. Dark green background represents transparency. Pick an overlay size:</div>
			<div name="display_border" style="text-align:center; color:#eaeaea; border:1px solid white; margin:0 auto">
			<label>
				<input type="radio" name="size" id="radio_small">
				<img id="image_small">
			</label>
			</div>
			<br>
			<div name="display_border" style="text-align:center; color:#eaeaea; border:1px solid white; margin:0 auto">
			<label>
				<input type="radio" name="size" id="radio_medium" checked>
				<img id="image_medium">
			</label>
			</div>
			<br>
			<div name="display_border" style="text-align:center; color:#eaeaea; border:1px solid white; margin:0 auto">
			<label>
				<input type="radio" name="size" id="radio_large">
				<img id="image_large">
			</label>
			</div>
			<br>
			<!--LittleFS implementation for the ESP8266 supports filenames of up to 31 characters + terminating zero. 31 - 4 (.bmp) = 27 -->
			<label>Filename: </label><input type="text" id="filename" maxlength="27" placeholder="Enter unique filename to save overlay image as." required><label>.bmp</label>
			<button type="submit">Upload</button>
			<div id="main_button" class="grid-item-button">
				<a href="/"><button name="">Main Menu</button></a>
			</div>
		</form>
		</div>
	</div>






	<script>
	base_url = '';
	if (window.location.protocol == "file:") {
		// makes for easier debugging.
		// if html is loaded locally, can see the results of editing more easily.
		// otherwise every change to html would require uploading new version to microcontroller.
		base_url = "http://jiftbox.local";
	}

	//const params = new Proxy(new URLSearchParams(window.location.search), {
	//	get: (searchParams, prop) => searchParams.get(prop),
	//});
	//const display_width = params.display_width;
	//const display_height = params.display_height;
	

	// set defaults but allow for webserver to replace templates
	// if you do not see the templates MY_WIDTH and MY_HEIGHT it is because
	// they were replaced with numbers
	let display_width = 240;  // default
	let display_height = 135; // default
	if (typeof $MY_WIDTH$ !== "undefined" && typeof $MY_HEIGHT$ !== "undefined") {
		display_width = $MY_WIDTH$;   // template substitution
		display_height = $MY_HEIGHT$; // template substitution
	}
	
	const mdim = Math.max(display_width, display_height);

	//const cwidth = Math.round(0.5*mdim);
	const cwidth = Math.round(0.25*mdim);
	const cheight = cwidth;
	
	const font_family = "Arial";
	const font_size = Math.round(0.80*cwidth) + "px";
	
	const factor_small = 0.50;
	const factor_medium = 0.75;
	const factor_large = 1.00;

	let ctx = document.getElementById('canvas').getContext('2d');
	let input = document.getElementById('text');
	
	let radio_small = document.getElementById('radio_small');
	let radio_medium = document.getElementById('radio_medium');
	let radio_large = document.getElementById('radio_large');
	let image_small = document.getElementById('image_small');
	let image_medium = document.getElementById('image_medium');
	let image_large = document.getElementById('image_large');

	const nodeList = document.querySelectorAll('[name="display_border"]');
	for (let i = 0; i < nodeList.length; i++) {
		nodeList[i].style.width = display_width + "px";
		nodeList[i].style.height = display_height + "px";
	}

	input.style.width = display_width + "px";
	input.style.fontFamily = font_family;
	input.style.fontSize = font_size;
	
	radio_small.value = factor_small;
	radio_medium.value = factor_medium;
	radio_large.value = factor_large;

	image_small.style.width = factor_small*cwidth + 'px';
	image_small.style.height = factor_small*cheight + 'px';
	image_medium.style.width = factor_medium*cwidth + 'px';
	image_medium.style.height = factor_medium*cheight + 'px';
	image_large.style.width = factor_large*cwidth + 'px';
	image_large.style.height = factor_large*cheight + 'px';


	function createHiPPICanvas(width, height) {
		const ratio = window.devicePixelRatio;
		const canvas = document.getElementById('canvas');

		canvas.width = width * ratio;
		canvas.height = height * ratio;
		canvas.style.width = width + "px";
		canvas.style.height = height + "px";
		canvas.getContext("2d").scale(ratio, ratio);
	}

	function convert(text) {
		document.getElementById('text').value = text;

		ctx.font = font_size +" "+ font_family;
		ctx.fillStyle = "#002400"; // transparent background
		ctx.fillRect(0, 0, cwidth, cheight);

		/*
		let metrics = ctx.measureText(this.value);
		let textWidth = metrics.width;
		let fontHeight = metrics.fontBoundingBoxAscent + metrics.fontBoundingBoxDescent;
		//let textHeight = metrics.actualBoundingBoxAscent + metrics.actualBoundingBoxDescent;

		console.log(fontHeight);

		//let textHeight = input.offsetHeight;
		//let textHeight = span.offsetHeight;
		let textHeight = 9;

		let x = (sizeWidth-textWidth)/2;
		let y = (sizeHeight+textHeight)/2;

		//console.log(textWidth);
		console.log("textHeight: "+textHeight);
 
		//console.log((sizeWidth-textWidth)/2);
		console.log("y: "+y);
		*/


		/*
		ctx.beginPath();
		ctx.moveTo(cwidth/2, 0);
		ctx.lineTo(cwidth/2, cheight);
		ctx.strokeStyle = '#00ff00';
		ctx.stroke();

		ctx.beginPath();
		ctx.moveTo(0, cheight/2);
		ctx.lineTo(cwidth, cheight/2);
		ctx.strokeStyle = '#ffffff';
		ctx.stroke();
		*/
 
		//ctx.fillText(this.value, x, y);

		ctx.textAlign = 'center';
		ctx.textBaseline = 'middle';
		ctx.fillStyle = "#FFFFFF"; // font color
		ctx.fillText(text, cwidth/2, cheight/2);

		console.log(text);

		image_small.src = ctx.canvas.toDataURL('image/bmp');
		image_medium.src = ctx.canvas.toDataURL('image/bmp');
		console.log(image_medium.src);
		image_large.src = ctx.canvas.toDataURL('image/bmp');
	}


	function upload() {
		const ratio = window.devicePixelRatio;
		const original_canvas = document.getElementById('canvas');
		
		let factor = document.querySelector('[type=radio]:checked').value;

		let new_canvas = document.createElement('canvas');
		//let new_canvas = document.getElementById("canvas_tmp");
		let context = new_canvas.getContext('2d');

		new_canvas.width = factor * original_canvas.width;
		new_canvas.height = factor * original_canvas.height;
		
		new_canvas.style.width = (factor * original_canvas.width) + 'px';
		new_canvas.style.height = (factor * original_canvas.height) + 'px';
		
		new_canvas.getContext("2d").scale(factor * ratio, factor * ratio);

		context.drawImage(original_canvas, 0, 0);

		//document.getElementById('image_canvas_tmp').src = context.canvas.toDataURL('image/bmp'); 

		new_canvas.toBlob((blob) => {

			const filename = '/overlays/' + document.getElementById('filename').value + '.bmp';
			let data = new FormData();
			data.append("upload", blob, filename);
			fetch(base_url+'/file_upload', {method:"POST", body:data})
				.then(response => console.log(response.text()));
		}, 'image/bmp');
	}


	createHiPPICanvas(cwidth, cheight);

	//input.addEventListener('keyup', convert, false);
	//input.addEventListener('click', convert, false);
	//input.addEventListener('change', convert, false);
	
	input.addEventListener('input', function(){convert(this.value)}, false);
	
	const emojiList = document.querySelectorAll('[name="emoji"]');
	for (let i = 0; i < emojiList.length; i++) {
		emojiList[i].addEventListener('click', function(){convert(this.value)}, false);
	}

	var event = new Event('input');
	input.dispatchEvent(event);

	</script>

</body>
</html>
