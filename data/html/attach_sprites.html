<!DOCTYPE html>
<html lang="en" class="">
<head>
	<meta charset='utf-8'>
	<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
	<title>Attach Sprites</title>
	<style>
	:root {
		--switch-color: white;
	}
	
	body {
		color: #eaeaea;
		background: black;
		text-align: center;
		font-family: verdana, sans-serif;
	}
	#flex_container {
		display: flex;
		flex-wrap: wrap;
	}
	.grid-container {
		flex: 1;
		display: grid;
		grid-template-columns: repeat(5, auto);
		grid-row-gap: 5px;
		/*width: 100%;*/
		/*height: 85vh;*/
		/*max-width: 600px;*/
		/*max-height: 800px;*/
  		justify-content: center;
		margin: 0 auto;
		border-style: solid;
	}
	.grid-item-bg-img {
		grid-column: 1 / span 5;
		text-align: center;
		margin: auto;
	}
	.grid-item-msg,
	.grid-item-button {
		grid-column: 1;
	}

	button {
		border: 0;
		border-radius: 0.3rem;
		background: #1fa3ec;
		color: #faffff;
		line-height: 2.4rem;
		font-size: 1.2rem;
		width: 100%;
		-webkit-transition-duration: 0.4s;
		transition-duration: 0.4s;
		cursor: pointer;
		font-weight:bold;
		text-align: center;
		width: 100%;
	}
	
	button:hover {
		background: #0e70a4;
	}
	
	.bred {
		background: #d43535;
	}
	
	.bred:hover {
		background: #931f1f;
	}
	
	.bgrn {
		background: #47c266;
	}
	
	.bgrn:hover {
		background: #5aaf6f;
	}

	a:link {
		color: inherit;
		text-decoration: none;
	}

	a:visited {
		color: inherit;
		text-decoration: none;
	}

	a:hover {
		color: yellow;
		text-decoration: none;
	}

	a:active {
		color: inherit;
		text-decoration: none;
	}
	</style>
</head>
<body>

	<div id="maindiv" style="visibility: hidden">
		<h3>Attach sprites to images.</h3>
		<form id="sprites_form" action="upload" method="POST"></form>
		<div id="flex_container">
			<div id="insert_before_here" class="grid-item-button"></div>
		</div>
		<button id="upload_settings" form="sprites_form" onclick="upload_settings()">Update Sprites</button>
		<div id="main_button" class="grid-item-button">
			<a href="/"><button name="">Main Menu</button></a>
		</div>
	</div>


	<script type="text/javascript">
	var g_sprites = [];
	// set defaults but allow for webserver to replace templates
	// if you do not see the templates MY_WIDTH and MY_HEIGHT it is because
	// they were replaced with numbers
	let g_bg_canvas_w = 240;  // default
	let g_bg_canvas_h = 135; // default
	if (typeof $MY_WIDTH$ !== "undefined" && typeof $MY_HEIGHT$ !== "undefined") {
		g_bg_canvas_w = $MY_WIDTH$;   // template substitution
		g_bg_canvas_h = $MY_HEIGHT$; // template substitution
	}
	const g_sprite_canvas_wh = 33;
	
	base_url = '';
	if (window.location.protocol == "file:") {
		// makes for easier debugging.
		// if html is loaded locally, can see the results of editing more easily.
		// otherwise every change to html would require uploading new version to microcontroller.
		base_url = "http://jiftbox.local";
	}
	

	function load_bg_images_sequential(el_imgs) {
		if (!el_imgs.length) {
			return;
		}

		let el_img = el_imgs.shift();
		let url = base_url + el_img.getAttribute('data-filename');

		el_img.onload = function () {
				load_bg_images_sequential(el_imgs);
		}
		el_img.src = url;
	}


	function load_sprite(el_sprite) {
		let sprite_name = el_sprite.value;
		let el_img = document.getElementById( "sprite_img_" + el_sprite.getAttribute("data-index") + "_" + el_sprite.getAttribute("data-filename")  );
		if (sprite_name.startsWith("/sprites")) {

			image = new Image();
			image.onload = function () {
					ctx = el_img.getContext('2d');
					ctx.drawImage(this, 0, 0, this.width, this.height, 0, 0, g_sprite_canvas_wh, g_sprite_canvas_wh);
			}
			image.src = base_url + sprite_name;
		}
	}


	function insert_assignment_elements(responseText) {
		var maindiv = document.getElementById("maindiv");
		var container = document.getElementById("flex_container");

		var insert_point = document.getElementById("insert_before_here");

		if (responseText != "") {
			var files = responseText.split('\n');
			for (var i in files) {
				if (files[i] != "" && !files[i].endsWith('/')) {
					var filename = files[i];
					filename = filename.slice(0, filename.lastIndexOf('\t'));

					var sprite_div = document.createElement("div");
					sprite_div.classList.add("grid-container");

					var bg_img = document.createElement("img");
					bg_img.classList.add("grid-item-bg-img");
					bg_img.setAttribute("id", 'bg_img_'+filename);
					bg_img.setAttribute("data-filename", filename);
					bg_img.setAttribute("alt", `Loading image ${filename}. GIFs take a while to load.`);
					bg_img.width = g_bg_canvas_w;
					bg_img.style.width = g_bg_canvas_w + "px";
					bg_img.height = g_bg_canvas_h;
					bg_img.style.height = g_bg_canvas_h + "px";
					sprite_div.appendChild(bg_img);

					var label
					label = document.createElement("label");
					label.innerHTML = ""; // thumbnail
					sprite_div.appendChild(label);
					label = document.createElement("label");
					label.innerHTML = "Name";
					sprite_div.appendChild(label);
					label = document.createElement("label");
					label.innerHTML = "Count";
					sprite_div.appendChild(label);
					label = document.createElement("label");
					label.innerHTML = "Direction";
					sprite_div.appendChild(label);
					label = document.createElement("label");
					label.innerHTML = "Wind";
					sprite_div.appendChild(label);
	
					for (var onum = 0; onum < 3; onum++) {
						var img = document.createElement("canvas");
						img.setAttribute("id", 'sprite_img_'+onum+'_'+filename);
						img.width = g_sprite_canvas_wh;
						img.style.width = g_sprite_canvas_wh + "px";
						img.height = g_sprite_canvas_wh;
						img.style.height = g_sprite_canvas_wh + "px";
						sprite_div.appendChild(img);

						var sprite_select = document.createElement("select");
						sprite_select.setAttribute("id", 'sprite_select_'+onum+'_'+filename);
						sprite_select.setAttribute("name", 'sprite_select_'+onum+'_'+filename);
						sprite_select.setAttribute("form", "sprites_form");
						sprite_select.setAttribute("data-filename", filename);
						sprite_select.setAttribute("data-index", onum);
						sprite_select.setAttribute("onchange", "load_sprite(this)");
	
						var option = document.createElement("option");
						option.text = "No sprite";
						sprite_select.add(option);
						for (let j = 0; j < g_sprites.length; j++) {
							var option = document.createElement("option");
							option.value = g_sprites[j]; 
							option.text = g_sprites[j].replace('/sprites/', '');
							sprite_select.add(option);
						}

						sprite_div.appendChild(sprite_select);


						var sprite_cnt = document.createElement("input");
						sprite_cnt.setAttribute("type", "number");
						sprite_cnt.style.width = "40px";
						sprite_cnt.setAttribute("quantity", 1);
						sprite_cnt.setAttribute("min", 0);
						sprite_cnt.setAttribute("max", 50);
						sprite_cnt.setAttribute("value", 0);
						sprite_cnt.setAttribute("id", 'sprite_count_'+onum+'_'+filename);
						sprite_cnt.setAttribute("name", 'sprite_count_'+onum+'_'+filename);
						sprite_cnt.setAttribute("form", "sprites_form");

						sprite_div.appendChild(sprite_cnt);

						
						var dir_select = document.createElement("select");
						dir_select.setAttribute("id", 'sprite_dir_'+onum+'_'+filename);
						dir_select.setAttribute("name", 'sprite_dir_'+onum+'_'+filename);
						dir_select.setAttribute("form", "sprites_form");
						
						var option = document.createElement("option");
						option.text = "fall";
						option.value = "fall";
						dir_select.add(option);
						var option = document.createElement("option");
						option.text = "rise";
						option.value = "rise";
						dir_select.add(option);
						var option = document.createElement("option");
						option.text = "forward";
						option.value = "forward";
						dir_select.add(option);
						var option = document.createElement("option");
						option.text = "backward";
						option.value = "backward";
						dir_select.add(option);

						sprite_div.appendChild(dir_select);

						
						var wind_speed = document.createElement("input");
						wind_speed.setAttribute("type", "number");
						wind_speed.style.width = "40px";
						wind_speed.setAttribute("quantity", 1);
						wind_speed.setAttribute("min", 0);
						wind_speed.setAttribute("max", 50);
						wind_speed.setAttribute("value", 0);
						wind_speed.setAttribute("id", 'sprite_wind_'+onum+'_'+filename);
						wind_speed.setAttribute("name", 'sprite_wind_'+onum+'_'+filename);
						wind_speed.setAttribute("form", "sprites_form");

						sprite_div.appendChild(wind_speed);
					}
					container.insertBefore(sprite_div, insert_point);
				}
			}
		}
		else {
			var not_found_div = document.createElement("div");
			not_found_div.innerText = "No files found.";
			not_found_div.classList = "grid-item-msg";
			not_found_div.style = "color: white; text-align: center; width: 100%;"
			container.insertBefore(not_found_div, insert_point);
			insert_point.style.visibility = "hidden"; 
		}

		maindiv.style.visibility = "visible";
		
		let el_imgs = document.querySelectorAll('[id^="bg_img_"]');
		load_bg_images_sequential([ ...el_imgs]);
	}
	
	function create_sprite_files_list(responseText) {
		if (responseText != "") {
			var files = responseText.split('\n');
			for (var i in files) {
				if (files[i] != "" && !files[i].endsWith('/')) {
					var fnfs = files[i]; // filename and filesize separated by tab character
					var filename = fnfs.slice(0, fnfs.lastIndexOf('\t'));
					if (filename.toLowerCase().endsWith(".bmp")) {
						g_sprites.push(filename);
					}
				}
			}
		}
	}
	
	function create_sprite_settings_ui(responseText) {
		let sprite_settings = JSON.parse(responseText);
		let el_imgs = document.querySelectorAll('[id^="sprite_img_"]');
		let el_sprites = document.querySelectorAll('[id^="sprite_select_"]');
		let el_counts = document.querySelectorAll('[id^="sprite_count_"]');
		let el_directions = document.querySelectorAll('[id^="sprite_dir_"]');
		let el_winds = document.querySelectorAll('[id^="sprite_wind_"]');
		
		for (let i = 0; i < el_sprites.length; i++) {
			let el_img = el_imgs[i];
			let el_sprite = el_sprites[i];
			let el_count = el_counts[i];
			let el_direction = el_directions[i];
			let el_wind = el_winds[i];
			
			let filename = el_sprite.getAttribute('data-filename');
			let index = parseInt(el_sprite.getAttribute('data-index'));
	
			if (filename in sprite_settings) {
				for (let j = 0; j < el_sprite.options.length; j++) {
					// cannot directly set value because we cannot be sure the sprite file assigned in the json still exists in /sprites/
					// so loop through all of the options and set the sprite and attributes if the file in the json matches an existing sprite file option
					if (el_sprite.options[j].value === sprite_settings[filename][index]['file']) {
						el_sprite.selectedIndex = j;
						//if (sprite_settings[filename][index]['file'].startsWith("/sprites")) {
						if (sprite_settings[filename][index]['file'].toLowerCase().endsWith(".bmp")) {
							load_sprite(el_sprite);
						}
						value = sprite_settings[filename][index]['count'];
						if (typeof value !== 'undefined') {
							el_count.value = parseInt(value);
						}
						value = sprite_settings[filename][index]['direction'];
						if (typeof value !== 'undefined') {
							el_direction.value = value;
						}
						value = parseInt(sprite_settings[filename][index]['wind']);
						if (typeof value !== 'undefined') {
							el_wind.value = parseInt(value);
						}
						break;
					}
				}
			}
		}
	}


	function upload_status(json) {
		if (json["file_upload_status"] == 0) {
			console.log('File uploaded successfully.');
		}
		else {
			console.log('File upload failed.');
		}
	}
	
	function upload_settings() {
		let el_sprites = document.querySelectorAll('[id^="sprite_select_"]');
		let el_counts = document.querySelectorAll('[id^="sprite_count_"]');
		let el_directions = document.querySelectorAll('[id^="sprite_dir_"]');
		let el_winds = document.querySelectorAll('[id^="sprite_wind_"]');
		
		sprites_dict = {};
		for (let i = 0; i < el_sprites.length; i++) {
			let el_sprite = el_sprites[i];
			let el_count = el_counts[i];
			let el_direction = el_directions[i];
			let el_wind = el_winds[i];
	
			let filename = el_sprite.getAttribute('data-filename');
			let count = el_count.value; // do not use parseInt() because keeping everything as a string makes it easier to parse the JSON file
			let sprite_fname = el_sprite.options[el_sprite.selectedIndex].value;
			let direction = el_direction.options[el_direction.selectedIndex].value;
			let wind = el_wind.value;
			if (!(filename in sprites_dict)) {
				sprites_dict[filename] = [];
			}
			sprites_dict[filename].push({"file": sprite_fname, 'count': count, 'direction': direction, 'wind': wind});
		}
	
		console.log(JSON.stringify(sprites_dict));
	
		let form_data = new FormData();
		const blob = new Blob([JSON.stringify(sprites_dict)], { type: "application/json" });
		form_data.append("upload", blob, "/sprite_settings.json");
		
		fetch(base_url+'/file_upload', {method:"POST", body:form_data})
			.then(response => response.json())
			.then(data => upload_status(data));
	}
	
	
	async function load_data() {
		/*
		const [data1, data2] = await Promise.all([
			fetch(base_url+'/sprite_file_list'),
			fetch(base_url+'/file_list'),
		])
			.then(async (response) => {
				return Promise.all(
					response.map(async (data) => await data.text())
				)
		});
		*/
	
		const [data1, data2] = await Promise.all([
			fetch(base_url+'/sprite_file_list'),
			fetch(base_url+'/file_list'),
		]);		
	
		const rt1 = await data1.text();
		const rt2 = await data2.text();
		create_sprite_files_list(rt1);
		insert_assignment_elements(rt2);
	
		fetch(base_url+'/sprite_settings.json')
			.then(response => response.text())
			.then(data => create_sprite_settings_ui(data));		
	}
	
	load_data();

	
	</script>
</body>
</html>
