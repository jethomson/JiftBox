<!DOCTYPE html>
<html lang="en" class="">

<head>
<meta charset='utf-8'>
	<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
	<title>Upload Folder</title>
	<style>
	body {
		text-align: center;
		font-family: verdana, sans-serif;
		background: #000000;
	}

	div {
		padding: 5px;
		font-size: 1rem;
	}
	
	p {
		margin: 0.5rem 0;
	}
	
	button,
	input {
		border: 0;
		border-radius: 0.3rem;
		background: #1fa3ec;
		color: #faffff;
		line-height: 2.4rem;
		font-size: 1.2rem;
		width: 100%;
		-webkit-transition-duration: 0.4s;
		transition-duration: 0.4s;
		cursor: pointer;
	}
	
	input:hover {
		background: #0e70a4;
	}
	</style>
</head>

<body>
	<div style='text-align:left;display:inline-block;color:#eaeaea;min-width:340px;'>
		<div style='text-align:center;color:#eaeaea;'>
			<div style='text-align:center;'>Select a folder to upload.</div>
			<br>
			<p>
	  	<form id="upload" method="POST" onsubmit="event.preventDefault(); upload_files()">
				<input id='filesize' type="hidden" name="folder_upload" />
        <input id='file' type='file' name='update' webkitdirectory="" directory="" />
				<p></p>
				<input id='upload_btn' type='submit' value='Upload'>
			</form>
			</p>
			<div id="main_button" class="grid-item-button">
				<a href="/"><button name="">Main Menu</button></a>
			</div>
		</div>
		<div id="test_insert_here">
		</div>
	</div>

	<script type="text/javascript">
	base_url = '';
	if (window.location.protocol == "file:") {
		// makes for easier debugging.
		// if html is loaded locally, can see the results of editing more easily.
		// otherwise every change to html would require uploading new version to microcontroller.
		base_url = "http://jiftbox.local";
	}

	//need to handle upload failure, timeout, etc?
	function update_button_text(i) {
		let text = "Uploading";
		let j = i;
		while(j) {
			text = "." + text + '.';
			j--;
		}
		i = (i+1)%4;
		document.getElementById('upload_btn').value = text;
		(function(p){setTimeout(function(){update_button_text(p)}, 750)})(i);
	}
	
	function upload_status(json) {
		if (json["upload_status"] == 0) {
			//console.log('File uploaded successfully.');
			document.getElementById("btn_upload_settings").textContent = "Update Successful!";
		}
		else {
			//console.log('File upload failed.');
			document.getElementById("btn_upload_settings").textContent = "Update Failed :(";
		}
	}

  function convert_to_thumbnail(file, form_data) {
    return new Promise((resolve, reject) => {
      let filename = file.name;
      let thumbnail_fname = filename.replace(".gif", ".png");
      let webkitRelativePath = file.webkitRelativePath;
      let thumbnail_path = webkitRelativePath.replace(filename, "thumbnails/"+thumbnail_fname);

      let canvas = document.createElement("canvas");
      let fr = new FileReader();
      fr.onload = () => {
        let img = new Image();
        img.onload = () => {
    	    ctx = canvas.getContext('2d');
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0, img.width, img.height);
          canvas.toBlob(function(blob) {
            form_data.append("upload", blob, thumbnail_path);
            resolve(true);
          });
        }
        img.src = fr.result;
      };
      fr.readAsDataURL(file);
    });
  }

	async function upload_files() {
    //update_button_text(0);
		let form_data = new FormData(document.getElementById("upload"));
		let files = document.getElementById("file").files;
    for (let i = 0; i < files.length; i++) {
      if (files[i].name.endsWith(".gif")) {
        await convert_to_thumbnail(files[i], form_data);
      }
		}
		fetch(base_url+'/upload', {method:"POST", body:form_data})
  		.then(response => response.json())
			.then(data => upload_status(data));
	}
	</script>

</body>
</html>
